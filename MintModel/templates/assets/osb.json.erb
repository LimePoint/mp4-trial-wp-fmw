<%# This builds 12.2.1.0 OSB %>

<% environment_name = @environment['name'] %>
<% dns_domain = @osb["dns_domain"] ; if dns_domain.nil? then dns_domain=".mintpress.io" end %>
<% osb_asset_code = 'osb' %>

<% uniquifier = @uuid.tr('-', '') %>

<% java_install_path = '/oracle/app/' + environment_name + '/' + osb_asset_code + '/java' %>
<% inventory_install_path = '/oracle/app/' + environment_name + '/' + osb_asset_code + '/oraInventory' %>
<% osb_install_path = '/oracle/app/' + environment_name + '/' + osb_asset_code + '/fmw' %>
<% osb_admin_server_top = '/oracle/app' + '/' + environment_name + '/' + osb_asset_code + '/environments' %>
<% osb_managed_server_top = '/oracle/app' + '/' + environment_name + '/' + osb_asset_code + '/environments' %>
<% osb_log_location = '/oracle/logs' + '/' + environment_name + '/' + osb_asset_code %>
<% temp_location = '/oracle/app' + '/' + environment_name + '/' + osb_asset_code  + '/tmp' %>

<% osb_admin_server_heap = '2g' %>

{
  "internalVariables":
  {
    "environmentName": "<%= environment_name %>",
    "assetGroup": "<%= @uuid %>",
    "assetCode": "<%= osb_asset_code %>",
    "defaultHostTargetUsername": "oracle",
    "defaultHostTargetPassword": "oinstall",
    "defaultHostTargetTmpDirectory": "<%= temp_location %>",
    "stageRootDir": "/oracle/stage",
    "privatePostfix": ""
  },
  "projectName": "<%= osb_asset_code %>_<%= uniquifier %>",
  "uniquifier": "<%= uniquifier %>",
  "site": {
    "hostList": [
      {
        "id": "<%= @hostList[0] %>",
        "user": "${defaultHostTargetUsername}",
        "password": "<%= SecretVault.get('mycredentials/dev1/obpsoa', 'wls_admin', default: 'welcome1') %>",
        "address": "<%= @hostList[0] %><%= dns_domain %>",
        "attributes": {
          "targetTempDir": "${defaultHostTargetTmpDirectory}",
          "target.tmp.dir": "${defaultHostTargetTmpDirectory}"
        }
      },
      {
        "id": "<%= @osb['db_host'] %>",
        "user": "${defaultHostTargetUsername}",
        "password": "<%= PasswordVault.get_password('mycredentials/dev1/obpsoa2', 'wls_admin', 'welcome1') %>",
        "address": "<%= @osb['db_host'] %><%= dns_domain %>",
        "attributes": {
          "targetTempDir": "${defaultHostTargetTmpDirectory}",
          "target.tmp.dir": "${defaultHostTargetTmpDirectory}"
        }
      }
    ],
    "installationList": [

      {
        "name": "<%= environment_name %>_<%= osb_asset_code %>_jdk",
        "product": "jdk",
        "version": "1.8_91",
        "installPath": "<%= java_install_path %>",
        "softwareStage": "${stageRootDir}/jdk/jdk-8u91-linux-x64.tar.gz",
        "attributes": {
          "newworld": "true",
          "inventory_location": "<%= inventory_install_path %>"
        }
      },
      {
        "name": "<%= environment_name %>_<%= osb_asset_code %>_fmwinfra",
        "product": "OracleFMWInfrastructure",
        "version": "<%= @osb['version'] %>",
        "softwareStage": "${stageRootDir}/fmwinfra/<%= @osb['version'] %>/fmw_<%= @osb['longversion'] %>_infrastructure.jar",
        "installPath": "<%= osb_install_path %>",
        "dependsonList": [
          "<%= environment_name %>_<%= osb_asset_code %>_jdk"
        ],
        "attributes": {
          "newworld": "true",
          "OracleFMWInfrastructure": {
            "inventory_location": "<%= inventory_install_path %>",
            "fmw_home": "<%= osb_install_path %>",
          }
        }
      },
      {
        "name": "<%= environment_name %>_<%= osb_asset_code %>_osb",
        "product": "OracleServiceBus",
        "version": "<%= @osb['version'] %>",
        "installPath": "<%= osb_install_path %>/osb",
        "softwareStage": "${stageRootDir}/osb/<%= @osb['version'] %>/fmw_<%= @osb['longversion'] %>_osb.jar",
        "dependsonList": [
          "<%= environment_name %>_<%= osb_asset_code %>_fmwinfra"
        ],
        "attributes": {
          "newworld": "true",
          "OracleServiceBus": {
            "inventory_location": "<%= inventory_install_path %>",
            "fmw_home": "<%= osb_install_path %>"
          }
        }
      }

    ],
    "environmentName":  "<%= environment_name %>",
    "topologyName":  "<%= osb_asset_code %>",

    "nodeManagerList": [
      {
        "name": "nm-<%= @hostList[0] %>",
        "type": "Plain",
        "hostIdentifier": "<%= @hostList[0] %>",
        "groupRefs": [
          "Node_Manager_Config"
        ],
        "attributes": {
          "listenAddress": "<%= @hostList[0] %>${privatePostfix}<%= dns_domain %>",
          "listenPort": "<%= @osb['node_manager_port'] %>"
        }
      }
    ],
    "domainList": [
      {
        "name": "osb_domain",
        "locationPath": "<%= osb_admin_server_top %>",
        "adminUser": "weblogic",
        "adminPassword": "<%= @osb['wls_admin_password'] %>",
        "adminServer": {
          "name": "AdminServer",
          "machineName": "Machine-<%= @hostList[0] %>",
          "listenAddress": "<%= @hostList[0] %>${privatePostfix}<%= dns_domain %>",
          "listenAddressPort": "<%= @osb['wls_admin_listen_port'].to_i %>",
          "listenAddressPortSSL": "<%= @osb['wls_admin_listen_port'].to_i+1000 %>"
        },
        "machineList": [
          {
            "name": "Machine-<%= @hostList[0] %>",
            "nodeManagerName": "nm-<%= @hostList[0] %>"
          }
        ],
        "clusterList": [
          {
            "name": "osb_cluster",
            "messageMode": "Unicast"
          }
        ],
        "managedServerList": [
          {
            "name": "osb_server1",
            "machineName": "Machine-<%= @hostList[0] %>",
            "listenAddress": "<%= @hostList[0] %>${privatePostfix}<%= dns_domain %>",
            "listenAddressPort": "<%= @osb['wls_server_port_pool'].to_i %>",
            "listenAddressPortSSL": "<%= @osb['wls_server_port_pool'].to_i + 1000 %>",
            "clusterName": "osb_cluster"
          }
        ],
        "middlewareList": [
          {
            "installationName": "<%= environment_name %>_<%= osb_asset_code %>_osb",
            "targetList": [
              {
                "type": "Cluster",
                "names":
                [
                  "osb_cluster"
                ]
              }
            ]
          }
        ],
        "configurationList": [
          {
            "resourceName": "GenericServerSettings",
            "type": "Server",
            "attributes": {
              "serverName": "AdminServer"
            }
          },
          {
            "resourceName": "GenericServerSettings",
            "type": "Server",
            "attributes": {
              "serverName": "osb_server1"
            }
          },
          {
            "resourceName": "AdminStartupParameters",
            "type": "StartupParameter",
            "targets": [
              {
                "type": "SERVER",
                "names": [
                  "AdminServer"
                ]
              }
            ]
          },
          {
            "resourceName": "ClusterStartupParameters",
            "type": "StartupParameter",
            "targets": [
              {
                "type": "CLUSTER",
                "names": [
                  "osb_cluster"
                ]
              }
            ]
          },
          {
            "resourceName": "DomainWebappConfig",
            "type": "WebAppContainer"
          },
          {
            "resourceName": "DomainLogConfiguration",
            "type": "DomainLog"
          }
        ],
        "templateList": [
          {
            "name": "OracleServiceBus::TemplateSet"
          }
        ],
        "repositoryList": [
          {
            "componentList": [
              "SOAINFRA",
              "OPSS"
            ],
            "dbName": "<%= environment_name %><%= osb_asset_code %>db",
            "schemaPassword": "<%= @osb['rcu_schema_password'] %>",
            "prefix": "<%= @osb['rcu_schema_prefix'] %>",
            "dbUser": "<%= @osb['db_sysdba_username'] %>",
            "id": "rcu01",
            "defaultRepository": "true"
          }
        ],
        "attributes": {
          "newworld": "true",
          "serverStartMode": "prod",
          "wls.production.mode": "prod",
          "backupEnvironmentName": "<%= environment_name %>",
          "environment.name": "<%= environment_name %>"
        }
      }
    ],
    "hostInstallationList": [
      {
        "installationName": "<%= environment_name %>_<%= osb_asset_code %>_osb",
        "hostIdentifierList": [
          "<%= @hostList[0] %>"
        ]
      }
    ]
  ,
    "databaseList": [
      {
        "name": "<%= environment_name %><%= osb_asset_code %>db",
        "port": "<%= @osb['db_listen_port'] %>",
        "serviceName": "<%= @osb['db_name'] %>",
        "hostIdentifier": "<%= @osb['db_host'] %>",
        "schemaList": [
          {
            "name": "<%= @osb['db_sysdba_username'] %>",
            "password": "<%= @osb['db_sysdba_password'] %>"
          }
        ],
        "attributes": {
          "rcu.datafile.prefix": "+DATA/<%= @osb['db_name'] %>",
          "rcu.datafile.autonaming": "false",
          "rcu.datafile.initialsize": "200M",
          "jdbcUrl": "jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(Host=${_.host.address})(Port=${_.port}))(CONNECT_DATA=(SERVICE_NAME=${_.serviceName})))"
        }
      }
    ],
    "resourceList": [
      {
        "name": "DomainWebappConfig",
        "type": "WebAppContainer",
        "attributes": {
          "WeblogicPluginEnabled": "true",
          "XPoweredByHeaderLevel": "NONE"
        }
      },
      {
        "name": "GenericServerSettings",
        "type": "Server",
        "params": [
          {
            "type": "Log",
            "attributes": {
              "FileName": "<%= osb_log_location %>/${/domains.name}/%Name%/access.log"
            }
          },
          {
            "type": "WebServer",
            "params": [
              {
                "type": "WebServerLog",
                "attributes": {
                  "FileName": "<%= osb_log_location %>/${/domains.name}/%Name%/access.log"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "AdminStartupParameters",
        "type": "StartupParameter",
        "attributes": {
          "Auto01": "-Dweblogic.Stdout=<%= osb_log_location %>/${/domains.name}/%Name%/%Name%.out",
          "Auto03": "-Dweblogic.Stderr=<%= osb_log_location %>/${/domains.name}/%Name%/%Name%.err",
          "Auto05": "-Xms<%= osb_admin_server_heap %> -Xmx<%= osb_admin_server_heap %>"
        }
      },
      {
        "name": "ClusterStartupParameters",
        "type": "StartupParameter",
        "attributes": {
          "Auto01": "-Dweblogic.Stdout=<%= osb_log_location %>/${/domains.name}/%Name%/%Name%.out",
          "Auto03": "-Dweblogic.Stderr=<%= osb_log_location %>/${/domains.name}/%Name%/%Name%.err",
          "4": "-Xmx4g -XX:MaxPermSize=2g"
        }
      },
      {
        "attributes": {
          "FileName": "<%= osb_log_location %>/${/domains.name}.log"
        },
        "type": "DomainLog",
        "name": "DomainLogConfiguration"
      }
    ],
    "propertyGroupList":
    [
      {
        "name": "Node_Manager_Config",
        "description": "Node Manager configuration",
        "attributes": {
          "nmssl": "false",
          "wls.nodemanager.secure.listener": "false",
          "wls_nodemanager_setidentity": "false",
          "wls.nodemanager.setidentity": "false",
          "wlInstallationName": "<%= environment_name %>_<%= osb_asset_code %>_fmwinfra",
          "nodemanagerTop": "<%= osb_install_path %>/wlserver/common/nodemanager",
          "wls.nodemanager.top": "<%= osb_install_path %>/wlserver/common/nodemanager"
        }
      }
    ]
  }
}
