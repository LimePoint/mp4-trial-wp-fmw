<% environment_name = @environment['name'] %>
<% dns_domain = @bpm["dns_domain"] ; if dns_domain.nil? then dns_domain=".mintpress.io" end %>
<% bpm_asset_code = 'bpm' %>

<% uniquifier = @uuid.tr('-', '') %>

<% java_install_path = '/oracle/app/' + environment_name + '/' + bpm_asset_code + '/java' %>
<% inventory_install_path = '/oracle/app/' + environment_name + '/' + bpm_asset_code + '/oraInventory' %>
<% bpm_install_path = '/oracle/app/' + environment_name + '/' + bpm_asset_code + '/fmw' %>
<% bpm_admin_server_top = '/oracle/app' + '/' + environment_name + '/' + bpm_asset_code + '/environments' %>
<% bpm_managed_server_top = '/oracle/app' + '/' + environment_name + '/' + bpm_asset_code + '/environments' %>
<% bpm_log_location = '/oracle/logs' + '/' + environment_name + '/' + bpm_asset_code %>
<% temp_location = '/oracle/app' + '/' + environment_name + '/' + bpm_asset_code  + '/tmp' %>

<% bpm_admin_server_heap = '2g' %>


{
  "internalVariables":
  {
    "environmentName": "<%= environment_name %>",
    "assetGroup": "<%= @uuid %>",
    "assetCode": "<%= bpm_asset_code %>",
    "defaultHostTargetUsername": "oracle",
    "defaultHostTargetPassword": "oinstall",
    "defaultHostTargetTmpDirectory": "<%= temp_location %>",
    "stageRootDir": "/oracle/stage",
    "privatePostfix": ""
  },
  "projectName": "<%= bpm_asset_code %>_<%= uniquifier %>",
  "uniquifier": "<%= uniquifier %>",
  "site": {
    "hostList": [
      {
        "id": "<%= @hostList[0] %>",
        "user": "${defaultHostTargetUsername}",
        "password": "${defaultHostTargetPassword}",
        "address": "<%= @hostList[0] %><%= dns_domain %>",
        "attributes": {
          "targetTempDir": "${defaultHostTargetTmpDirectory}",
          "target.tmp.dir": "${defaultHostTargetTmpDirectory}"
        }
      },
      {
        "id": "<%= @bpm['db_host'] %>",
        "user": "${defaultHostTargetUsername}",
        "password": "${defaultHostTargetPassword}",
        "address": "<%= @bpm['db_host'] %><%= dns_domain %>",
        "attributes": {
          "targetTempDir": "${defaultHostTargetTmpDirectory}",
          "target.tmp.dir": "${defaultHostTargetTmpDirectory}"
        }
      }
    ],
    "installationList": [

      {
        "name": "<%= environment_name %>_<%= bpm_asset_code %>_jdk",
        "product": "jdk",
        "version": "1.8.0_91",
        "installPath": "<%= java_install_path %>",
        "softwareStage": "${stageRootDir}/jdk/jdk-8u91-linux-x64.tar.gz",
        "attributes": {
          "newworld": "true",
          "inventory_location": "<%= inventory_install_path %>"
        }
      },
      {
        "name": "<%= environment_name %>_<%= bpm_asset_code %>_fmwinfra",
        "product": "fmwinfra",
        "version": "<%= @bpm['version'] %>",
        "installPath": "<%= bpm_install_path %>",
        "softwareStage": "${stageRootDir}/fmwinfra/<%= @bpm['version'] %>/fmw_<%= @bpm['longversion'] %>_infrastructure.jar",
        "dependsonList": [
          "<%= environment_name %>_<%= bpm_asset_code %>_jdk"
        ],
        "attributes": {
          "newworld": "true",
          "inventory_location": "<%= inventory_install_path %>",
          "fmw_home": "<%= bpm_install_path %>"
        }
      },
      {
        "name": "<%= environment_name %>_<%= bpm_asset_code %>_bpm",
        "product": "bpm",
        "version": "<%= @bpm['version'] %>",
        "installPath": "<%= bpm_install_path %>/bpm",
        "softwareStage": "${stageRootDir}/soa/<%= @bpm['version'] %>/fmw_<%= @bpm['longversion'] %>_soa.jar",
        "dependsonList": [
          "<%= environment_name %>_<%= bpm_asset_code %>_fmwinfra"
        ],
        "attributes": {
          "newworld": "true",
          "inventory_location": "<%= inventory_install_path %>",
          "fmw_home": "<%= bpm_install_path %>"
        }
      }

    ],
    "environmentName":  "<%= environment_name %>",
    "topologyName":  "<%= bpm_asset_code %>",

    "nodeManagerList": [
      {
        "name": "nm-<%= @hostList[0] %>",
        "type": "Plain",
        "hostIdentifier": "<%= @hostList[0] %>",
        "groupRefs": [
          "Node_Manager_Config"
        ],
        "attributes": {
          "listenAddress": "<%= @hostList[0] %>${privatePostfix}<%= dns_domain %>",
          "listenPort": "<%= @bpm['node_manager_port'] %>"
        }
      }
    ],
    "domainList": [
      {
        "name": "bpm_domain",
        "locationPath": "<%= bpm_admin_server_top %>",
        "adminUser": "weblogic",
        "adminPassword": "<%= @bpm['wls_admin_password'] %>",
        "adminServer": {
          "name": "AdminServer",
          "machineName": "Machine-<%= @hostList[0] %>",
          "listenAddress": "<%= @hostList[0] %>${privatePostfix}<%= dns_domain %>",
          "listenAddressPort": "<%= @bpm['wls_admin_listen_port'].to_i %>",
          "listenAddressPortSSL": "<%= @bpm['wls_admin_listen_port'].to_i+1000 %>"
        },
        "machineList": [
          {
            "name": "Machine-<%= @hostList[0] %>",
            "nodeManagerName": "nm-<%= @hostList[0] %>"
          }
        ],
        "clusterList": [
          {
            "name": "bpm_cluster",
            "messageMode": "Unicast"
          }
        ],
        "managedServerList": [
          {
            "name": "soa_server1",
            "machineName": "Machine-<%= @hostList[0] %>",
            "listenAddress": "<%= @hostList[0] %>${privatePostfix}<%= dns_domain %>",
            "listenAddressPort": "<%= @bpm['wls_server_port_pool'].to_i %>",
            "listenAddressPortSSL": "<%= @bpm['wls_server_port_pool'].to_i + 1000 %>",
            "clusterName": "bpm_cluster"
          }
        ],
        "middlewareList": [
          {
            "installationName": "<%= environment_name %>_<%= bpm_asset_code %>_bpm",
            "targetList": [
              {
                "type": "Cluster",
                "names":
                [
                  "bpm_cluster"
                ]
              }
            ]
          }
        ],
        "configurationList": [
          {
            "resourceName": "GenericServerSettings",
            "type": "Server",
            "attributes": {
              "serverName": "AdminServer"
            }
          },
          {
            "resourceName": "GenericServerSettings",
            "type": "Server",
            "attributes": {
              "serverName": "soa_server1"
            }
          },
          {
            "resourceName": "AdminStartupParameters",
            "type": "StartupParameter",
            "targets": [
              {
                "type": "SERVER",
                "names": [
                  "AdminServer"
                ]
              }
            ]
          },
          {
            "resourceName": "ClusterStartupParameters",
            "type": "StartupParameter",
            "targets": [
              {
                "type": "CLUSTER",
                "names": [
                  "bpm_cluster"
                ]
              }
            ]
          },
          {
            "resourceName": "DomainWebappConfig",
            "type": "WebAppContainer"
          },
          {
            "resourceName": "DomainLogConfiguration",
            "type": "DomainLog"
          }
        ],
        "templateList": [
          {
            "name": "OracleBPMSuite::TemplateSet"
          }
        ],
        "repositoryList": [
          {
            "componentList": [
              "SOAINFRA"
            ],
            "dbName": "<%= environment_name %><%= bpm_asset_code %>db",
            "schemaPassword": "<%= @bpm['rcu_schema_password'] %>",
            "prefix": "<%= @bpm['rcu_schema_prefix'] %>",
            "dbUser": "<%= @bpm['db_sysdba_username'] %>",
            "id": "rcu01",
            "defaultRepository": "true"
          }
        ],
        "attributes": {
          "newworld": "true",
          "serverStartMode": "prod",
          "wls.production.mode": "prod",
          "backupEnvironmentName": "<%= environment_name %>",
          "environment.name": "<%= environment_name %>"
        }
      }
    ],
    "executeList": [
      {
        "name": "DeleteDemoTrustEntry",
        "hostIdentifierList": [
          "<%= @hostList[0] %>"
        ],
        "sourceFile": "cd <%= bpm_admin_server_top %>/bpm_domain/bin/;cp -f setDomainEnv.sh setDomainEnv.sh.mint; sed -i 's|-Djavax.net.ssl.trustStore=\\${WL_HOME}/server/lib/DemoTrust.jks||g' setDomainEnv.sh; sed -i 's|-Dtangosol.coherence.clusteraddress=227.7.7.12||g' setDomainEnv.sh; sed -i 's|-Dtangosol.coherence.clusterport=9778||g' setDomainEnv.sh",
        "executeWhenList": [
          "post-configure"
        ]
      }
    ],
    "hostInstallationList": [
      {
        "installationName": "<%= environment_name %>_<%= bpm_asset_code %>_bpm",
        "hostIdentifierList": [
          "<%= @hostList[0] %>"
        ]
      }
    ]
  ,
    "databaseList": [
      {
        "name": "<%= environment_name %><%= bpm_asset_code %>db",
        "port": "<%= @bpm['db_listen_port'] %>",
        "serviceName": "<%= @bpm['db_name'] %>",
        "hostIdentifier": "<%= @bpm['db_host'] %>",
        "schemaList": [
          {
            "name": "<%= @bpm['db_sysdba_username'] %>",
            "password": "<%= @bpm['db_sysdba_password'] %>"
          }
        ],
        "attributes": {
          "rcu.datafile.prefix": "+DATA/<%= @bpm['db_name'] %>",
          "rcu.datafile.autonaming": "false",
          "rcu.datafile.initialsize": "200M",
          "jdbcUrl": "jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(Host=${_.host.address})(Port=${_.port}))(CONNECT_DATA=(SERVICE_NAME=${_.serviceName})))"
        }
      }
    ],
    "resourceList": [
      {
        "name": "DomainWebappConfig",
        "type": "WebAppContainer",
        "attributes": {
          "WeblogicPluginEnabled": "true",
          "XPoweredByHeaderLevel": "NONE"
        }
      },
      {
        "name": "GenericServerSettings",
        "type": "Server",
        "params": [
          {
            "type": "Log",
            "attributes": {
              "FileName": "<%= bpm_log_location %>/${/domains.name}/%Name%/access.log"
            }
          },
          {
            "type": "WebServer",
            "params": [
              {
                "type": "WebServerLog",
                "attributes": {
                  "FileName": "<%= bpm_log_location %>/${/domains.name}/%Name%/access.log"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "AdminStartupParameters",
        "type": "StartupParameter",
        "attributes": {
          "Auto01": "-Dweblogic.Stdout=<%= bpm_log_location %>/${/domains.name}/%Name%/%Name%.out",
          "Auto03": "-Dweblogic.Stderr=<%= bpm_log_location %>/${/domains.name}/%Name%/%Name%.err",
          "Auto05": "-Xms<%= bpm_admin_server_heap %> -Xmx<%= bpm_admin_server_heap %>"
        }
      },
      {
        "name": "ClusterStartupParameters",
        "type": "StartupParameter",
        "attributes": {
          "Auto01": "-Dweblogic.Stdout=<%= bpm_log_location %>/${/domains.name}/%Name%/%Name%.out",
          "Auto03": "-Dweblogic.Stderr=<%= bpm_log_location %>/${/domains.name}/%Name%/%Name%.err"
        }
      },
      {
        "attributes": {
          "FileName": "<%= bpm_log_location %>/${/domains.name}.log"
        },
        "type": "DomainLog",
        "name": "DomainLogConfiguration"
      }
    ],
    "propertyGroupList":
    [
      {
        "name": "Node_Manager_Config",
        "description": "Node Manager configuration",
        "attributes": {
          "nmssl": "false",
          "wls.nodemanager.secure.listener": "false",
          "wls_nodemanager_setidentity": "false",
          "wls.nodemanager.setidentity": "false",
          "wlInstallationName": "<%= environment_name %>_<%= bpm_asset_code %>_fmwinfra",
          "nodemanagerTop": "<%= bpm_install_path %>/wlserver/common/nodemanager",
          "wls.nodemanager.top": "<%= bpm_install_path %>/wlserver/common/nodemanager"
        }
      }
    ]
  }
}
